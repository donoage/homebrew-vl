#!/usr/bin/env python3

import sys
import os
import platform
import subprocess
import datetime
import webbrowser
import time

def print_usage():
    """Print usage instructions."""
    print("Usage: vl TICKER")
    print("Example: vl AAPL")
    sys.exit(1)

def main():
    """Main function."""
    # Check if ticker argument is provided
    if len(sys.argv) < 2:
        print_usage()
    
    # Get the ticker from command line argument
    ticker = sys.argv[1].upper()
    print(f"Using ticker: {ticker}")
    
    # Get today's date in YYYY-MM-DD format
    today = datetime.date.today().strftime("%Y-%m-%d")
    print(f"Using today's date: {today}")
    
    # Calculate dates for different timeframes
    three_months_ago = (datetime.date.today() - datetime.timedelta(days=90)).strftime("%Y-%m-%d")
    one_month_ago = (datetime.date.today() - datetime.timedelta(days=30)).strftime("%Y-%m-%d")
    one_week_ago = (datetime.date.today() - datetime.timedelta(days=7)).strftime("%Y-%m-%d")
    
    # Construct URLs with the provided ticker and dates
    url1 = f"https://www.volumeleaders.com/Chart?StartDate={three_months_ago}&EndDate={today}&Ticker={ticker}&MinVolume=0&MaxVolume=2000000000&MinDollars=500000&MaxDollars=300000000000&MinPrice=0&MaxPrice=100000&DarkPools=-1&Sweeps=-1&LatePrints=-1&SignaturePrints=0&VolumeProfile=0&Levels=5&TradeCount=5&VCD=0&TradeRank=-1&IncludePremarket=1&IncludeRTH=1&IncludeAH=1&IncludeOpening=1&IncludeClosing=1&IncludePhantom=1&IncludeOffsetting=1"
    
    url2 = f"https://www.volumeleaders.com/Chart?StartDate={one_month_ago}&EndDate={today}&Ticker={ticker}&MinVolume=0&MaxVolume=2000000000&MinDollars=500000&MaxDollars=300000000000&MinPrice=0&MaxPrice=100000&DarkPools=1&Sweeps=1&LatePrints=-1&SignaturePrints=0&VolumeProfile=0&Levels=5&TradeCount=5&VCD=0&TradeRank=-1&IncludePremarket=1&IncludeRTH=1&IncludeAH=1&IncludeOpening=1&IncludeClosing=1&IncludePhantom=1&IncludeOffsetting=1"
    
    url3 = f"https://www.volumeleaders.com/Chart?StartDate={one_month_ago}&EndDate={today}&Ticker={ticker}&MinVolume=0&MaxVolume=2000000000&MinDollars=500000&MaxDollars=300000000000&MinPrice=0&MaxPrice=100000&DarkPools=-1&Sweeps=-1&LatePrints=-1&SignaturePrints=0&VolumeProfile=0&Levels=5&TradeCount=5&VCD=0&TradeRank=-1&IncludePremarket=1&IncludeRTH=1&IncludeAH=1&IncludeOpening=1&IncludeClosing=1&IncludePhantom=1&IncludeOffsetting=1"
    
    url4 = f"https://www.volumeleaders.com/Chart?StartDate={one_week_ago}&EndDate={today}&Ticker={ticker}&MinVolume=0&MaxVolume=2000000000&MinDollars=500000&MaxDollars=300000000000&MinPrice=0&MaxPrice=100000&DarkPools=1&Sweeps=1&LatePrints=-1&SignaturePrints=0&VolumeProfile=0&Levels=5&TradeCount=5&VCD=0&TradeRank=-1&IncludePremarket=1&IncludeRTH=1&IncludeAH=1&IncludeOpening=1&IncludeClosing=1&IncludePhantom=1&IncludeOffsetting=1"
    
    # Detect operating system
    system = platform.system()
    
    # Check if running in WSL
    is_wsl = False
    if system == "Linux":
        try:
            with open('/proc/version', 'r') as f:
                if 'microsoft' in f.read().lower():
                    is_wsl = True
                    print("Detected Windows Subsystem for Linux (WSL)")
        except:
            pass
    
    if system == "Darwin":  # macOS
        print("Detected macOS - Using AppleScript for window positioning")
        open_urls_macos(url1, url2, url3, url4)
    elif system == "Windows" or is_wsl:  # Windows or WSL
        if is_wsl:
            print("Using WSL-specific browser opening method")
            open_urls_wsl(url1, url2, url3, url4)
        else:
            print("Detected Windows - Opening URLs in default browser")
            open_urls_windows(url1, url2, url3, url4)
    else:  # Linux or other
        print(f"Detected {system} - Opening URLs in default browser")
        open_urls_default(url1, url2, url3, url4)

def get_screen_dimensions_macos():
    """Get screen dimensions on macOS using AppleScript."""
    applescript = '''
    tell application "Finder"
        set _bounds to bounds of window of desktop
        set screenWidth to item 3 of _bounds
        set screenHeight to item 4 of _bounds
        return screenWidth & "," & screenHeight
    end tell
    '''
    
    try:
        result = subprocess.run(["osascript", "-e", applescript], capture_output=True, text=True)
        if result.stdout.strip():
            dimensions = result.stdout.strip().split(',')
            if len(dimensions) == 2:
                screen_width = int(float(dimensions[0]))
                screen_height = int(float(dimensions[1]))
                return screen_width, screen_height
        
        # If we got here, try an alternative method
        applescript_alt = '''
        tell application "System Events"
            set _display to first display
            return (value of _display's width) & "," & (value of _display's height)
        end tell
        '''
        
        result = subprocess.run(["osascript", "-e", applescript_alt], capture_output=True, text=True)
        if result.stdout.strip():
            dimensions = result.stdout.strip().split(',')
            if len(dimensions) == 2:
                screen_width = int(float(dimensions[0]))
                screen_height = int(float(dimensions[1]))
                return screen_width, screen_height
                
        # If we still don't have dimensions, fallback to defaults
        return 2880, 1600
    except Exception as e:
        print(f"Error getting screen dimensions: {e}")
        # Fallback to default values
        return 2880, 1600

def open_urls_macos(url1, url2, url3, url4):
    """Open URLs on macOS with Chrome and position windows."""
    # Get screen dimensions
    screen_width, screen_height = get_screen_dimensions_macos()
    
    # Calculate half width and height
    half_width = screen_width // 2
    half_height = screen_height // 2
    
    print(f"Detected screen resolution: {screen_width}x{screen_height}")
    print(f"Window dimensions will be: {half_width}x{half_height}")
    
    # Make sure Chrome is running
    subprocess.run(["open", "-a", "Google Chrome"])
    time.sleep(1)
    
    # Check if VolumeLeaders windows already exist
    applescript = '''
    try
        tell application "Google Chrome"
            set vlWindows to {}
            repeat with w in windows
                try
                    set winURL to URL of active tab of w
                    if winURL contains "volumeleaders.com/Chart" then
                        set end of vlWindows to w
                    end if
                on error
                    # Skip if we can't get the URL
                end try
            end repeat
            return (count of vlWindows)
        end tell
    on error
        return 0
    end try
    '''
    
    result = subprocess.run(["osascript", "-e", applescript], capture_output=True, text=True)
    window_count = int(result.stdout.strip() or "0")
    
    if window_count >= 1:
        print(f"Found {window_count} existing VolumeLeaders windows. Updating them...")
        
        # Update existing windows
        applescript = f'''
        try
            tell application "Google Chrome"
                # Find all VolumeLeaders windows
                set vlWindows to {{}}
                repeat with w in windows
                    try
                        set winURL to URL of active tab of w
                        if winURL contains "volumeleaders.com/Chart" then
                            set end of vlWindows to w
                        end if
                    on error
                        # Skip if we can't get the URL
                    end try
                end repeat
                
                # Update VolumeLeaders windows, up to 4
                set windowCount to count of vlWindows
                
                # If we have at least 1 window, update it and position as window 1
                if windowCount >= 1 then
                    set w to item 1 of vlWindows
                    set bounds of w to {{0, 23, {half_width}, {half_height}}}
                    tell active tab of w to set URL to "{url1}"
                end if
                
                # If we have at least 2 windows, update the 2nd one
                if windowCount >= 2 then
                    set w to item 2 of vlWindows
                    set bounds of w to {{{half_width}, 23, {screen_width}, {half_height}}}
                    tell active tab of w to set URL to "{url2}"
                end if
                
                # If we have at least 3 windows, update the 3rd one
                if windowCount >= 3 then
                    set w to item 3 of vlWindows
                    set bounds of w to {{0, {half_height}, {half_width}, {screen_height}}}
                    tell active tab of w to set URL to "{url3}"
                end if
                
                # If we have at least 4 windows, update the 4th one
                if windowCount >= 4 then
                    set w to item 4 of vlWindows
                    set bounds of w to {{{half_width}, {half_height}, {screen_width}, {screen_height}}}
                    tell active tab of w to set URL to "{url4}"
                end if
                
                # Create any additional windows we need (if we found fewer than 4)
                if windowCount < 4 then
                    # Create window 2 if needed
                    if windowCount < 2 then
                        make new window with properties {{bounds:{{{half_width}, 23, {screen_width}, {half_height}}}}}
                        tell active tab of front window to set URL to "{url2}"
                        delay 0.5
                    end if
                    
                    # Create window 3 if needed
                    if windowCount < 3 then
                        make new window with properties {{bounds:{{0, {half_height}, {half_width}, {screen_height}}}}}
                        tell active tab of front window to set URL to "{url3}"
                        delay 0.5
                    end if
                    
                    # Create window 4 if needed
                    if windowCount < 4 then
                        make new window with properties {{bounds:{{{half_width}, {half_height}, {screen_width}, {screen_height}}}}}
                        tell active tab of front window to set URL to "{url4}"
                    end if
                end if
            end tell
        on error errMsg
            return "ERROR: " & errMsg
        end try
        '''
        
        subprocess.run(["osascript", "-e", applescript])
        print(f"Updated chart windows for {sys.argv[1].upper()}")
    else:
        # No existing windows found, create new ones
        print(f"Creating new chart windows for {sys.argv[1].upper()}...")
        
        applescript = f'''
        tell application "Google Chrome"
            # Window 1: Top-Left - 3 month chart
            make new window with properties {{bounds:{{0, 23, {half_width}, {half_height}}}}}
            tell active tab of front window to set URL to "{url1}"
            delay 0.5
            
            # Window 2: Top-Right - 1 month chart with dark pools and sweeps
            make new window with properties {{bounds:{{{half_width}, 23, {screen_width}, {half_height}}}}}
            tell active tab of front window to set URL to "{url2}"
            delay 0.5
            
            # Window 3: Bottom-Left - 1 month chart
            make new window with properties {{bounds:{{0, {half_height}, {half_width}, {screen_height}}}}}
            tell active tab of front window to set URL to "{url3}"
            delay 0.5
            
            # Window 4: Bottom-Right - 1 week chart with dark pools and sweeps
            make new window with properties {{bounds:{{{half_width}, {half_height}, {screen_width}, {screen_height}}}}}
            tell active tab of front window to set URL to "{url4}"
        end tell
        '''
        
        subprocess.run(["osascript", "-e", applescript])
        print(f"Successfully created chart windows for {sys.argv[1].upper()}")

def open_urls_wsl(url1, url2, url3, url4):
    """Open URLs when running in WSL environment."""
    try:
        # Try to use powershell.exe to open URLs in the Windows host's browser
        print("Opening URLs using Windows host browser...")
        
        # Escape quotes in URLs for PowerShell
        ps_url1 = url1.replace('"', '\\"')
        ps_url2 = url2.replace('"', '\\"')
        ps_url3 = url3.replace('"', '\\"')
        ps_url4 = url4.replace('"', '\\"')
        
        # Open each URL using powershell.exe Start-Process
        subprocess.run(['powershell.exe', '-Command', f'Start-Process "{ps_url1}"'])
        time.sleep(1)
        subprocess.run(['powershell.exe', '-Command', f'Start-Process "{ps_url2}"'])
        time.sleep(1)
        subprocess.run(['powershell.exe', '-Command', f'Start-Process "{ps_url3}"'])
        time.sleep(1)
        subprocess.run(['powershell.exe', '-Command', f'Start-Process "{ps_url4}"'])
        
    except Exception as e:
        print(f"WSL browser opening method failed: {e}")
        print("Trying alternative method with cmd.exe...")
        
        try:
            # Alternative approach using cmd.exe and start command
            subprocess.run(['cmd.exe', '/c', f'start {url1}'])
            time.sleep(1)
            subprocess.run(['cmd.exe', '/c', f'start {url2}'])
            time.sleep(1)
            subprocess.run(['cmd.exe', '/c', f'start {url3}'])
            time.sleep(1)
            subprocess.run(['cmd.exe', '/c', f'start {url4}'])
            
        except Exception as e2:
            print(f"Alternative WSL method failed: {e2}")
            print("Please manually open the following URLs:")
            print(f"URL 1: {url1}")
            print(f"URL 2: {url2}")
            print(f"URL 3: {url3}")
            print(f"URL 4: {url4}")

def open_urls_windows(url1, url2, url3, url4):
    """Open URLs on Windows."""
    try:
        # Try to use the more advanced method with PowerShell
        print("Attempting to use PowerShell for window positioning...")
        
        # PowerShell script to open Chrome with specific window positions
        ps_script = f'''
        # Function to open Chrome with a URL at a specific position
        function Open-ChromeAtPosition($Url, $X, $Y, $Width, $Height) {{
            $chrome = Start-Process "chrome.exe" -ArgumentList "$Url" -PassThru
            Start-Sleep -Seconds 1
            
            # Load Windows Forms assembly for screen resolution
            Add-Type -AssemblyName System.Windows.Forms
            
            # Try to position the window
            try {{
                $wshell = New-Object -ComObject wscript.shell
                $wshell.AppActivate($chrome.Id)
                
                # Move and resize window
                $wshell.SendKeys('%')
                $wshell.SendKeys(' ')
                $wshell.SendKeys('m')
                
                # Move to position
                [System.Windows.Forms.Cursor]::Position = New-Object System.Drawing.Point($X, $Y)
                Start-Sleep -Milliseconds 100
                $wshell.SendKeys('{{LEFT}}')
                Start-Sleep -Milliseconds 100
                
                # Resize window
                $wshell.SendKeys('%')
                $wshell.SendKeys(' ')
                $wshell.SendKeys('s')
                
                # Set size
                $wshell.SendKeys('{{RIGHT}}')
                for ($i = 0; $i -lt $Width; $i += 10) {{
                    $wshell.SendKeys('{{RIGHT}}')
                    Start-Sleep -Milliseconds 10
                }}
                
                $wshell.SendKeys('{{DOWN}}')
                for ($i = 0; $i -lt $Height; $i += 10) {{
                    $wshell.SendKeys('{{DOWN}}')
                    Start-Sleep -Milliseconds 10
                }}
                
                $wshell.SendKeys('{{ENTER}}')
            }} catch {{
                Write-Host "Error positioning window: $_"
            }}
            
            return $chrome
        }}
        
        # Get screen dimensions
        $screen = [System.Windows.Forms.Screen]::PrimaryScreen
        $screenWidth = $screen.Bounds.Width
        $screenHeight = $screen.Bounds.Height
        
        Write-Host "Detected screen resolution: $screenWidth x $screenHeight"
        
        # Calculate half dimensions
        $halfWidth = $screenWidth / 2
        $halfHeight = $screenHeight / 2
        
        Write-Host "Window dimensions will be: $halfWidth x $halfHeight"
        
        # Open Chrome windows in a grid
        $chrome1 = Open-ChromeAtPosition "{url1}" 0 0 $halfWidth $halfHeight
        $chrome2 = Open-ChromeAtPosition "{url2}" $halfWidth 0 $halfWidth $halfHeight
        $chrome3 = Open-ChromeAtPosition "{url3}" 0 $halfHeight $halfWidth $halfHeight
        $chrome4 = Open-ChromeAtPosition "{url4}" $halfWidth $halfHeight $halfWidth $halfHeight
        
        Write-Host "Windows positioned successfully"
        '''
        
        # Save PowerShell script to temp file
        ps_path = os.path.join(os.environ.get('TEMP', ''), 'vl_chrome_windows.ps1')
        with open(ps_path, 'w') as f:
            f.write(ps_script)
        
        # Execute PowerShell script
        subprocess.run(['powershell', '-ExecutionPolicy', 'Bypass', '-File', ps_path], check=True)
        
        # Clean up temp file
        try:
            os.remove(ps_path)
        except:
            pass
            
    except Exception as e:
        print(f"PowerShell method failed: {e}")
        print("Falling back to simple browser opening method...")
        
        # Fallback to simple method
        webbrowser.open(url1)
        time.sleep(1)
        webbrowser.open(url2)
        time.sleep(1)
        webbrowser.open(url3)
        time.sleep(1)
        webbrowser.open(url4)

def open_urls_default(url1, url2, url3, url4):
    """Open URLs on other platforms using the default browser."""
    print("Opening URLs in default browser...")
    webbrowser.open(url1)
    time.sleep(1)
    webbrowser.open(url2)
    time.sleep(1)
    webbrowser.open(url3)
    time.sleep(1)
    webbrowser.open(url4)

if __name__ == "__main__":
    main() 